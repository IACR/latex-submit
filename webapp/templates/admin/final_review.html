{% extends "admin/admin_base.html" %}
{% block head %}
{{ super() }}
<style>
 img.icon {
   width: 16px;
   cursor: pointer;
   margin-top: .25rem;
   margin-bottom: .25rem;
 }
 .discussionTabs {
   max-height:70vh;
   overflow-y:scroll;
 }
 ul.nav .nav-item button.active, .tab-content {
   background-color: #f0f0f0;
 }
 alert.list-group-item {
   opacity: 0;
   transition: all 0.6s ease-out;
 }
 alert.list-group-item.show {
   opacity: 1;
 }
 /* for diffs. Some CSS is added with javascript. */
 td {
   padding-left: 5px;
   padding-right: 5px;
 }
 h5.filename {
   padding: 5px 5px 5px 20px;
   background-color: #f0d0d0;
 }
 th.diff_header {
   background-color: #e0e0e0;
   padding: 5px 5px 5px 20px;
 }
 div[data-status="PENDING"] {
   display:none;
  }
 div[data-status="WILLFIX"] {
   background-color: #c0ffc0;
  }
 div[data-status="CLARIFY"] {
   background-color: #f0c0f0;
  }
 div[data-status="DECLINED"] {
   background-color: #fff3cd;
 }
 /* these are resizable. */
 .left-column {
   width: 75%;
 }
 .right-column {
   width: 25%;
 }
 /* Reduce the font size for side-by-side diffs on small screens */
 @media only screen and (max-width: 1100px) {
   div#diffs {
     font-size: .75rem;
   }
 }
</style>
<script src="/js/resize.js"></script>
{# this template is used for generating notes from javascript. #}
<script id="item-template" type="text/template">
  <alert class="alert list-group-item list-group-item-secondary fade show" id="item-<% id %>">
    <div class="d-flex justify-content-between">
      <div>Page <span id="pageno-<% id %>"><% pageno %></span>,
        line <span id="lineno-<% id %>"><% lineno %></span><br>
        <span id="text-<% id %>"><% text %></span>
      </div>
      <div class="ps-2 d-flex flex-column align-items-end">
        <img src="/img/delete-icon.svg" class="icon" onclick="deleteNote(<% id %>)">
        {# <img src="/img/edit-icon.svg" class="icon" onclick="editNote(<% id %>)">#}
      </div>
    </div>
  </alert>
</script>
<script>
 function resetForm() {
   document.getElementById('error_msg').classList.add('d-none');
   document.getElementById('pageno').value = null;
   document.getElementById('lineno').value = null;
   document.getElementById('text').value = '';
 }

 {#  We never finished this. #}
 function editNote(id) {
   console.log('edit ' + id);
 }

 function deleteNote(id) {
   console.log('deleting ' + id);
   let data = {'action': 'delete', 'id': id};
   fetch('/admin/comment', {
     method: "POST",
     mode: "cors",
     cache: "no-cache",
     credentials: "same-origin",
     headers: {
       "Content-Type": "application/json",
     },
     redirect: "follow",
     body: JSON.stringify(data)
   }).then((response) => response.json()).then((data) => {
     console.log(data);
     if ('id' in data) {
       let elem = document.getElementById('item-' + data['id']);
       elem.ontransitionend = function() {
         elem.remove();
       }
       elem.classList.remove('show');
       console.log('removed ' + data['id']);
     }
   });
 }

 function appendComment(id, pageno, lineno, text) {
   let template = document.getElementById('item-template').innerHTML;
   // TODO: Use a better template system like handlebars?
   template = template.replace(/<% id %>/g, id)
                      .replace(/<% pageno %>/g, pageno)
                      .replace(/<% lineno %>/g, lineno)
                      .replace(/<% text %>/g, text);
   let discussion = document.getElementById('discussion');
   discussion.innerHTML = discussion.innerHTML + template;
 }

 function setErrorMessage(txt) {
   let error_msg = document.getElementById('error_msg');
   error_msg.innerHTML = txt;
   if (txt === "") {
     error_msg.classList.add('d-none');
   } else {
     error_msg.classList.remove('d-none');
   }
 }

 {# This works by sending making basic checks on the client and then sending
   it to the server to get the ID back. #}
 function addComment() {
   let text = document.getElementById('text').value;
   if (text === '') {
     setErrorMessage('You must supply note to author');
     return;
   }
   let lineno = +document.getElementById('lineno').value;
   if (lineno < 0) {
     setErrorMessage('Invalid line number');
     return;
   }
   let pageno = +document.getElementById('pageno').value;
   if (pageno < 1) {
     setErrorMessage('Invalid page number');
     return;
   }
   let data = {'action': 'add',
               'paperid': '{{paper.paperid}}',
               'pageno': +document.getElementById('pageno').value,
               'lineno': +document.getElementById('lineno').value,
               'text': document.getElementById('text').value,
               'creator_id': +document.getElementById('creator_id').value};
   resetForm();
   fetch('/admin/comment', {
     method: "POST",
     mode: "cors", // no-cors, *cors, same-origin
     cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
     credentials: "same-origin", // include, *same-origin, omit
     headers: {
       "Content-Type": "application/json",
     },
     redirect: "follow", // manual, *follow, error
     body: JSON.stringify(data), // body data type must match "Content-Type" header
   }).then((response) => response.json()).then((data) => {
     console.dir(data);
     if ("error" in data) {
       setErrorMessage(data['error']);
       return;
     }
     appendComment(data['id'], data['pageno'], data['lineno'], data['text']);
   });
 }

 {# Used for requesting a fix from a warning in the log. #}
 function requestFix(index) {
   document.getElementById('text').value = 'Please fix: ' + document.getElementById('warning-text-' + index).innerText;
   setErrorMessage('Please supply a page number and line number');
   const firstTab = document.querySelector('#myTab li:first-child button');
   bootstrap.Tab.getInstance(firstTab).show(); // Select the first tab.
   document.getElementById('warning-'+index).remove();
 }
</script>
{% endblock %}
{% block extraMenu %}
<li class="nav-item">
  <a class="btn btn-info" href="#" data-bs-toggle="modal" data-bs-target="#helpModal">Help</a>
</li>
{% endblock %}
{% block content %}
<main id="adminContent" class="container-fluid px-md-4">
  <div class="d-flex">
    <div class="resizable left-column" style="height:90vh;overflow-y:scroll;">
      <ul class="nav nav-tabs align-items-end" id="reviewTabs" role="tablist">
        <div class="nav-text me-5"><h2 class="mb-2">Final copy edit check for {{paper.paperid}}</h2></div>
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pdfs-tab" data-bs-toggle="tab" data-bs-target="#pdfs" type="button" role="tab" aria-controls="pdfs" aria-selected="true">PDFs</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="diffs-tab" data-bs-toggle="tab" data-bs-target="#diffs" type="button" role="tab" aria-controls="diffs" aria-selected="false">Diffs</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab" aria-controls="logs" aria-selected="false">Log</button>
        </li>
      </ul>
      <div class="tab-content" id="reviewTabsContent">
        <div class="tab-pane fade show active pe-2" id="pdfs" role="tabpanel" aria-labelledby="pdfs-tab" tabindex="0">
          <div class="d-flex w-100" style="height:80vh;">
            <div style="width:50%">
              <h4 class="mt-2 text-center">Original</h4>
              <embed width="100%" height="100%" src="{{url_for('home_bp.show_pdf', paperid=paper.paperid,version='copyedit',auth=pdf_copyedit_auth)}}#view=fitH">
            </div>
            <div class="resizer mx-2"></div>
            <div style="width:50%;">
              <h4 class="mt-2 text-center">Final</h4>
              <embed width="100%" height="100%" src="{{url_for('home_bp.show_pdf', paperid=paper.paperid,version='final',auth=pdf_final_auth)}}#view=fitH">
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="diffs" role="tabpanel" aria-labelledby="diffs-tab" tabindex="0">
          <h4 class="p-2 mb-0">Differences are shown only for tex files.</h4>
          {% for name, value in diffs.items() %}
          <h5 class="filename">{{name}}</h5>
          {{value|safe}}
          {% endfor %}
        </div>
        <div class="tab-pane fade" id="logs" role="tabpanel" aria-labelledby="logs-tab" tabindex="0">
          <pre>{{log}}</pre>
        </div>
      </div>
    </div>
    <div class="resizer"></div>
    <div class="resizable ps-3 right-column">
      <div class="d-flex flex-column" style="height:90vh;">
        <p>Status: {{paper.status.value}}, Venue: {{paper.journal}}, author email: {{paper.email}}</p>
        <p class="alert alert-info alert-dismissible fade show mb-0" role="alert">
          The author has now responded to your original
          requests. Unless they have introduced a new problem or
          failed to respond adequately to your requests, you should
          approve this for publication.
          <button type="button" title="Dismiss" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close"></button>
        </p>
        <div class="row">
          <div class="col-6 text-center">
            <form METHOD="post" action="{{url_for('admin_file.approve_final', paperid=paperid)}}">
              <input type="hidden" id="paperid" name="paperid" value="{{paper.paperid}}">
              <button class="my-4 btn btn-success" type="submit">Approve for publishing</button>
            </form>
          </div>
          <div class="col-6 text-center">
            <form METHOD="post" action="{#{{url_for('admin_file.request_more_changes', paperid=paperid)}}#}">
              <input type="hidden" id="paperid" name="paperid" value="{{paper.paperid}}">
              <button class="my-4 btn btn-warning" type="submit" title="Still to be implemented. Use email?">Request more changes</button>
            </form>
          </div>
        </div>
        {#  tabs for discussion and warnings from compilation #}
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback" type="button" role="tab" aria-controls="feedback" aria-selected="true">Responses</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="log-tab" data-bs-toggle="tab" data-bs-target="#log" type="button" role="tab" aria-controls="log" aria-selected="false">Warnings</button>
        </li>
      </ul>
      {# tabs to be shown #}
      <div id="tabContent" class="tab-content p-3">
        <div class="tab-pane fade show active" id="feedback" role="tabpanel" aria-labelledby="feedback-tab" tabindex="0">
          <div id="discussion" class="list-group mt-3 discussionTabs">
            {% for item in discussion %}
            <div class="alert alert-secondary">
              <div id="item-div-{{item.id}}" class="mb-2">
                <div>Page {{item.pageno}}, line {{item.lineno}}</div>
                <span>{{item.text}}</span>
              </div>
              <div class="item px-3 p-1" data-status="{{item.status.name}}" id="item-{{item.id}}">
                Response:  <span id="status-{{item.id}}">{{item.status.value}}</span>. <span id="reply-{{item.id}}">{% if item.reply %}{{item.reply}}{% endif %}</span>
              </div>
            </div>                
            {% endfor %}
          </div>
        </div>
        <div class="tab-pane fade" id="log" role="tabpanel" aria-labelledby="log-tab" tabindex="0">
          <p>Authors have already seen these, but apparently
            ignored them. You can request them to fix individual items.
          </p>
          <div class="list-group discussionTabs">
            {% if warnings %}
            {% for warning in warnings %}
            <div id="warning-{{loop.index}}" class="alert alert-warning alert-dismissible fade show">
              {{warning}}
              <button type="button" title="Dismiss" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
            {% else %}
            <div class="alert alert-info">There were no warnings from the compilation.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>  
{# modal for help. #}
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="helpModalLabel">Help for copy editors</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h3>Overview</h3>
        <p>
          Your job as a copy editor is a little vague, but the
          overriding principle is:
          <em>If it's not wrong, don't change it.</em> A useful
          resource for copy editing of mathematics was
          <a target="_blank" href="https://docplayer.net/122465-Mathematics-into-type.html">published by the AMS</a>
          and revised in 1999 to reflect the usage of LaTeX. This is
          quite old, but still useful.
        </p>
        <p>
          One principle that we stive for is that metadata should be
          carefully checked. The LaTeX style is designed to encourage
          authors to supply all necessary metadata, but there are
          still some things that authors will overlook. These include:
        </p>
        <h4>ORCID IDs</h4>
        <p>
          All authors should supply an ORCID ID. There are very few exceptions
          to this rule (dead authors qualify).
        </p>
        <h4>Author names</h4>
        <p>
          Author names should be written as they appear on other papers. You
          should be skeptical of names that are written with only initials or
          authors that are written in ALLCAPS.
        </p>
        <h4>Bibliographic references</h4>
        <p>
          The references should be checked carefully. We encourage authors to
          use <a target="_blank" href="https://cryptobib.di.ens.fr/">CryptoBib</a>,
          which is a large carefully curated BibTeX database of crypto
          and security literature. One thing to check for is that
          authors will sometimes omit DOIs from their references. In
          some cases this is acceptable, since not everything has a
          DOI; ACM SODA and USENIX conferences are notable examples.
          Other references like standards or company documents may
          also lack DOIs. If something doesn't have a DOI, you can
          still request that authors at least supply a useful URL. The
          compilation will flag these references to make it easy for you
          to find them.
        </p>
        <h3>The user interface</h3>
        <p>
          Your task is to build a set of things that the author should correct,
          and send them to the author for them to revise their paper and re-upload
          their LaTeX. We do not assume that you know LaTeX, but it can be useful
          in giving guidance to the author when something doesn't look right.
        </p>
        <p>
          The main components of the user interface are:
        </p>
        <ol>
          <li>The author PDF on the left. The version you are seeing has line numbers,
            but the final version will not. They are present only for you to refer
            to parts of the document.
          </li>
          <li>A column on the right with two tabs:
            <ol>
              <li>A form to construct comments to the author. Each comment has a page number,
                line number, and your text note. These are not sent to the author until you
                click the button at the bottom right to "Finish and send to authors."
              </li>
              <li>
                A tab with possible warnings from the LaTeX compilation. These usually include
                things like missing DOIs, overfull <code>\hboxes</code>, and characters
                that may not have been rendered correctly. They can be difficult to decipher,
                but you may wish to ask the author to fix them.
              </li>
            </ol>
          </li>
        </ol>
        <h3>The workflow</h3>
        <p>
          Once you finish with your review and click on the "Finalize"
          button at the bottom, then your suggestions are sent to the
          author. They are then given a chance to fix their LaTeX and
          upload their "final" version. You will be notified when this
          happens, and you will have a chance to check and make sure
          authors have performed all of the changes. If they do not,
          then we recommend communicating with the authors over email
          until you are satisfied.
        </p>
        <h3>Bugs</h3>
        <p>
          This system is all new as of 2023, and there are bound to be
          bugs. You can write to iacrcc-editors@iacr.org if you need
          help.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<script>
 document.querySelectorAll('td a').forEach((el) => {
   el.parentElement.nextElementSibling.nextElementSibling.style.backgroundColor='#e0c0e0';
 });

</script>
{% endblock %}
