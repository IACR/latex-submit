{% extends "admin/admin_base.html" %}
{% block head %}
{{ super() }}
<style>
 img.icon {
   width: 16px;
   cursor: pointer;
   margin-top: .25rem;
   margin-bottom: .25rem;
 }
 alert.list-group-item {
   opacity: 0;
   transition: all 0.6s ease-out;
 }
 alert.list-group-item.show {
   opacity: 1;
 }

</style>
{# this template is used for generating notes from javascript. #}
<script id="item-template" type="text/template">
  <alert class="alert list-group-item list-group-item-secondary fade show" id="item-<% id %>">
    <div class="d-flex justify-content-between">
      <div>Page <span id="pageno-<% id %>"><% pageno %></span>,
        line <span id="lineno-<% id %>"><% lineno %></span><br>
        <span id="text-<% id %>"><% text %></span>
      </div>
      <div class="ps-2 d-flex flex-column align-items-end">
        <img src="/img/delete-icon.svg" class="icon" onclick="deleteNote(<% id %>)">
        {# <img src="/img/edit-icon.svg" class="icon" onclick="editNote(<% id %>)">#}
      </div>
    </div>
  </alert>
</script>
<script>
 function resetForm() {
   document.getElementById('error_msg').classList.add('d-none');
   document.getElementById('pageno').value = null;
   document.getElementById('lineno').value = null;
   document.getElementById('text').value = '';
 }

 {# This sends a comment to the server and gets a response before
   it is added to the UI.  #}
 async function sendComment() {
   let lineno = +document.getElementById('lineno').value;
   let pageno = +document.getElementById('pageno').value;
   if (lineno <= 0 || pageno <= 0) {
     console.log('invalid fields');
     return {"error": "Invalid fields"};
   }
   let data = {'action': 'add',
               'paperid': '{{paper.paperid}}',
               'pageno': +document.getElementById('pageno').value,
               'lineno': +document.getElementById('lineno').value,
               'text': document.getElementById('text').value,
               'creator_id': +document.getElementById('creator_id').value};
   resetForm();
   const response = await fetch('/admin/comment', {
     method: "POST",
     mode: "cors", // no-cors, *cors, same-origin
     cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
     credentials: "same-origin", // include, *same-origin, omit
     headers: {
       "Content-Type": "application/json",
     },
     redirect: "follow", // manual, *follow, error
     body: JSON.stringify(data), // body data type must match "Content-Type" header
   });
   return response.json(); // parses JSON response into native JavaScript objects
 }
 function editNote(id) {
   console.log('edit ' + id);
 }
 function deleteNote(id) {
   console.log('deleting ' + id);
   let data = {'action': 'delete', 'id': id};
   fetch('/admin/comment', {
     method: "POST",
     mode: "cors",
     cache: "no-cache",
     credentials: "same-origin",
     headers: {
       "Content-Type": "application/json",
     },
     redirect: "follow",
     body: JSON.stringify(data)
   }).then((response) => response.json()).then((data) => {
     console.log(data);
     if ('id' in data) {
       let elem = document.getElementById('item-' + data['id']);
       elem.ontransitionend = function() {
         elem.remove();
       }
       elem.classList.remove('show');
       console.log('removed ' + data['id']);
     }
   });
 }
 function appendComment(id, pageno, lineno, text) {
   let template = document.getElementById('item-template').innerHTML;
   // TODO: Use a better template system like handlebars?
   template = template.replace(/<% id %>/g, id)
                      .replace(/<% pageno %>/g, pageno)
                      .replace(/<% lineno %>/g, lineno)
                      .replace(/<% text %>/g, text);
   let discussion = document.getElementById('discussion');
   discussion.innerHTML = discussion.innerHTML + template;
}
 function addComment() {
   let pageno = document.getElementById('pageno').value;
   let lineno = document.getElementById('lineno').value;
   let text = document.getElementById('text').value;
   sendComment().then((data) => {
     console.dir(data);
     if ("error" in data) {
       let error_msg = document.getElementById('error_msg');
       error_msg.innerHTML = 'Invalid page number or line number';
       error_msg.classList.remove('d-none');
       console.log("feedback of invalid data");
       return;
     }
     appendComment(data['id'], data['pageno'], data['lineno'], data['text']);
   });
 }
</script>
{% endblock %}
{% block content %}
  <main id="adminContent" class="container-fluid px-md-4">
<div class="row">
  <div class="col-8" id="pdf_viewer">
    <embed width="100%" height="100%" src="{{url_for('home_bp.show_pdf', paperid=paper.paperid,version='copyedit',auth=pdf_auth)}}#view=fitH">
  </div>
  <div class="col-4">
    <div class="d-flex flex-column" style="height:85vh;">
      <strong class="my-2 text-center">Copy edit on {{paper.paperid}} (Venue: {{paper.venue}}, author email: {{paper.email}})</strong>
      <input type="hidden" id="paperid" value="{{paper.paperid}}">
      <input type="hidden" id="creator_id" name="creator_id" value="{{current_user.id}}">
      <input type="hidden" id="copyedit_email" name="copyedit_email" value="{{current_user.email}}">
      <div class="row">
        <div class="col-6">
          <label for="pageno" class="form-label">Page number</label>
          <input id="pageno" name="pageno" required type="number" class="form-control">
        </div>
        <div class="col-6">
          <label for="lineno" class="form-label">Line number</label>
          <input id="lineno" name="lineno" required type="number" class="form-control">
        </div>
        <div class="col-12">
          <label for="text" class="form-label mt-3">Note to author</label>
        </div>
        <div class="col-12">
          <input id="text" name="text" type="text" class="form-control" required>
        </div>
      </div>
      <div id="error_msg" class="text-danger d-none"></div>
      <button type="submit" class="mt-3 btn btn-primary" onclick="addComment()">Add comment</button>
      <div id="discussion" class="list-group mt-3" style="max-height:70vh;overflow-y:scroll">
      </div>
      {# <script>
       {% for item in discussion %}
       console.log('adding item');
       appendComment({{item.id}}, {{item.pageno}}, {{item.lineno}}, "{{item.text}}");
       {% endfor %}
      </script> #}
    </div>
    <button class="my-3 btn btn-primary">Finish and send to author(s)</button>
    </div>
  </div>
</div>  
<script>
 document.getElementById('pdf_viewer').scrollIntoView({behavior: "smooth"});
 fetch('/admin/comments/{{paper.paperid}}', {
   method: "GET",
   cache: "no-cache",
   headers: {
     "Content-Type": "application/json"
   }
 }).then((response) => response.json()).then((data) => {
   console.dir(data);
   data.forEach(d => {
     appendComment(d['id'], d['pageno'], d['lineno'], d['text']);
   });
 });

</script>
{% endblock %}
