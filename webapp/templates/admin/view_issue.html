{% extends "admin/admin_base.html" %}
{% block content %}
<main id="adminContent" class="container-fluid admin-container px-md-4 py-3">
{% for message in get_flashed_messages() %}
<div class="alert alert-warning mt-3">
  {{ message }}
</div>
{% endfor %}
<div class="row">
  <div class="col-6">
    <h1 class="mb-2 text-center">{{title}}</h1>
    <p>
      This is a view of all papers that are tentatively scheduled to appear in Issue {{issue.name}}
      of Volume {{volume.name}} in {{journal.name}}.
    </p>
  </div>
  <div class="col-6">
    <table class="table">
      <tbody>
        <tr>
          <th>Uploaded papers:</th><td>{{papers|length}}</td>
        </tr>
        <tr>
          <th>Completed papers:</th><td>{{finished_papers}}</td>
        </tr>
        <tr>
          <th>Accepted but not submitted:</th>
          <td>{% if hotcrp %}{{hotcrp.acceptedPapers|length}}{% else %}no HotCRP instance{% endif %}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<div class="alert alert-info d-flex">
  <p>TODOs:</p>
  <ol>
    <li>figure out how to structure this form. Only papers with status of "Copy edit complete" can be published.</li>
    <li>Provide mechanism to change the paper to a later issue if the status is not <i-mono>copy_edit_accept</i-mono>.
      This is tricky if the author hasn't even uploaded anything yet, because we don't have a <i-mono>PaperStatus</i-mono>
      record yet.</li>
    <li>Provide mechanism to order these in the final issue.</li>
  </ol>
</div>
<h4 class="mt-4">Assigned papers</h4>
<table class="table sortable">
  <thead>
    <tr>
      <th></th>
      <th>paperid</th>
      <th>hotcrp</th>
      <th>status</th>
      <th>modified</th>
      <th>email</th>
      <th>Title &amp; authors</th>
    </tr>
  </thead>
  <tbody id="paperList">
    {% for status in papers %}
    <td>{% if status.status.name!='COPY_EDIT_ACCEPT' %}
      <form method="POST" action="{{url_for('admin_file.change_issue')}}">
        {{ bumpform.csrf_token }}
        {{ bumpform.nexturl(value=url_for('admin_file.view_issue', issueid=issue.id)) }}
        {{ bumpform.paperid(value=status.paperid) }}
        {{ bumpform.submit(class_='btn btn-sm btn-warning',value='bump') }}
      </form>
      {% endif %}
    </td>
    <td><a href="{{url_for('admin_file.show_admin_paper', paperid=status.paperid)}}">{{status.paperid}}</a></td>
    <td>{% if status.hotcrp == 'none' %}none{% else %}<a target="_blank" href="https://submit.iacr.org/{{status.hotcrp}}/paper/{{status.hotcrp_id}}">{{status.hotcrp}}/{{status.hotcrp_id}}</a>{% endif %}</td>
      <td class="status {{status.status.name}}">{{status.status.value}}</td>
      <td>{{status.lastmodified.strftime('%Y-%m-%d')}}</td>
      <td>{{status.email}}</td>
      <td>{{status.title}}<br><span class="fst-italic">{{status.authors}}</span></td>
    </tr>
    {% endfor %}
{% if hotcrp %}
{% for p in hotcrp.acceptedPapers %}
<tr>
  <td>{{p.paperid}}</td>
  <td><a target="_blank" href="https://submit.iacr.org/{{hotcrp.shortName}}/paper/{{p.paperId}}">{{hotcrp.shortName}}/{{p.paperId}}</a></td>
  <td class="UNSUBMITTED">Unsubmitted</td>
  <td>-</td>
  <td>-</td>
  <td>{{p.title}}<br>
      {% for author in p.authorlist %}
        {{author.name}} ({{author.affiliation}})
      {% endfor %}
   </td>
</tr>
{% endfor %}
{% endif %}
</tbody>
</table>
{% if unassigned_papers %}
<h4 class="mt-4">Unassigned papers</h4>
<table class="table">
  <thead>
    <tr>
      <th></th>
      <th>paperid</th>
      <th>status</th>
      <th>Title &amp; authors</th>
    </tr>
  </thead>
  <tbody id="unassigned">
    {% for paper in unassigned_papers %}
    <tr>
      <td>{% if paper.status.name == 'COPY_EDIT_ACCEPT' %}
        <form method="POST" action="{{url_for('admin_file.change_issue')}}">
          {{ includeform.csrf_token }}
          {{ includeform.paperid(value=paper.paperid) }}
          {{ includeform.issueid }}
          {{ includeform.nexturl }}
          {{ includeform.submit(class_='btn btn-sm btn-warning',value='include') }}
        </form>
        {% endif %}
      </td>
      <td><a href="{{url_for('admin_file.show_admin_paper', paperid=paper.paperid)}}">{{paper.paperid}}</a></td>
      <td class="status {{paper.status.name}}">{{paper.status.value}}</td>
      <td>{{paper.title}}<br><span class="fst-italic">{{paper.authors}}</span></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}
<form class="mt-3" action="{{url_for('admin_file.publish_issue')}}" METHOD="POST">
</form>
<script src="/js/sorttable.js"></script>
</main>
{% endblock %}
